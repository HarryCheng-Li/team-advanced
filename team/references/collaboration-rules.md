# Agent Team 协作规则

确保 Agent Team 高效协作的核心规则。

---

## 目录

1. [用户沟通规则](#1-用户沟通规则) ⭐ 新增
2. [需求澄清规则](#2-需求澄清规则) ⭐ 新增
3. [沟通规则](#3-沟通规则)
4. [任务管理](#4-任务管理)
5. [用户验收规则](#5-用户验收规则) ⭐ 新增
6. [上下文管理](#6-上下文管理)
7. [失败恢复](#7-失败恢复)
8. [质量保证](#8-质量保证)
9. [快速参考](#9-快速参考)

---

## 1. 用户沟通规则 ⭐ 新增

### 1.1 语言原则

```
✅ 使用: 简单、日常、用户熟悉的语言
❌ 避免: 技术术语、缩写、行话

如果必须使用技术术语，必须解释：
"数据库（存储数据的地方）"
"API（系统之间传输数据的接口）"
```

### 1.2 进度汇报格式

```markdown
# 进度报告

## 已完成
- 用户登录功能 ✅
- 密码找回功能 ✅

## 进行中
- 用户注册功能（预计 30 分钟完成）

## 下一步
- 完善用户资料页面
- 添加头像上传功能

## 需要您确认
- 登录后希望跳转到哪个页面？
```

### 1.3 汇报频率

| 任务复杂度 | 汇报频率 |
|------------|----------|
| 简单（< 1小时） | 完成时汇报 |
| 中等（1-4小时） | 每 30 分钟 |
| 复杂（> 4小时） | 每 1 小时 + 里程碑时 |
| 关键任务 | 实时 + 每个决策点 |

### 1.4 用户确认请求

```javascript
// 需要用户确认时
SendMessage({
  recipient: "product-owner",
  content: `需要用户确认：

问题: 在实现登录功能时，发现需要决定：
- 是否支持手机号登录？
- 还是只支持邮箱登录？

建议: 同时支持两种方式，更方便用户

请询问用户后告知决定。`,
  summary: "需要用户确认"
})
```

### 1.5 技术语言翻译对照

| 技术术语 | 用户语言 |
|----------|----------|
| 实现了 JWT 认证 | 登录后可以保持登录状态，不用重复输入密码 |
| 优化了数据库索引 | 页面加载速度更快了 |
| 修复了并发问题 | 多个人同时使用不会出问题了 |
| 重构了代码结构 | 让后续功能开发更快更稳定 |
| API 接口 | 数据传输通道 |
| 数据库 Schema | 数据存储结构 |
| 前端/后端 | 用户看到的界面 / 后台处理逻辑 |
| 缓存 | 临时存储，加快访问速度 |
| 回归测试 | 确保新功能不影响旧功能 |

---

## 2. 需求澄清规则 ⭐ 新增

### 2.1 澄清时机

必须澄清的情况：
- 用户描述模糊（"做一个好用的系统"）
- 可能有多种理解（"登录功能" - 账号密码？手机？第三方？）
- 涉及关键决策（影响后续开发方向）
- 用户可能不知道自己要什么

### 2.2 澄清问题模板

```yaml
用户场景:
  - "您能描述一下用户会在什么情况下使用这个功能吗？"
  - "用户使用这个功能时，是在电脑上还是手机上？"

期望效果:
  - "您希望这个功能实现什么效果？"
  - "如果没有这个功能，用户现在是怎么做的？"

重要程度:
  - "这个功能对您来说有多重要？必须有还是可以有？"
  - "如果时间有限，哪些是必须有？哪些可以后续加？"

边界情况:
  - "如果用户输入了错误的信息，您希望怎么处理？"
  - "如果系统出错了，用户应该看到什么？"
```

### 2.3 澄清文档模板

```markdown
# 需求理解

## 用户原始描述
<原文记录>

## 我的理解
<用简单语言重新描述>

## 用户想要解决的核心问题
<背后真正的问题>

## 验收标准（用户视角）
- [ ] 用户可以...
- [ ] 用户能够...
- [ ] ...

## 技术任务（内部）
1. ...
2. ...

## 向用户确认的话
"我理解您想要 X，主要解决 Y 的问题，对吗？"
```

### 2.4 需求变更处理

```javascript
// 用户提出需求变更时
SendMessage({
  recipient: "product-owner",
  content: `[需求变更]

用户提出: <新的需求>

影响分析:
- 已完成工作: <哪些需要调整>
- 预计增加时间: <时间估算>
- 建议: <建议方案>

请与用户确认:
1. 是否接受时间调整？
2. 是否有优先级调整？`,
  summary: "需求变更请求"
})
```

---

## 3. 沟通规则

### 3.1 消息类型选择

| 场景 | 类型 | 说明 |
|-----|------|------|
| 向用户汇报 | `message` → product-owner | 通过 product-owner |
| 请求特定成员 | `message` | 点对点，高效 |
| 紧急停止 | `broadcast` | 关键问题 |
| 任务完成 | `message` | 通知依赖方 |

### 3.2 响应时限

| 优先级 | 响应时间 |
|--------|----------|
| P0 紧急（用户无法使用） | 立即 |
| P1 高（功能问题） | 5分钟内 |
| P2 正常 | 30分钟内 |
| P3 低 | 2小时内 |

---

## 4. 任务管理

### 4.1 任务认领

```javascript
TaskUpdate({ taskId: "1", status: "in_progress", owner: "my-name" })

SendMessage({
  type: "message",
  recipient: "product-owner",
  content: "我已开始任务 X，预计 30 分钟完成",
  summary: "任务开始"
})
```

### 4.2 任务优先级

| 优先级 | 触发条件 | 处理策略 |
|--------|----------|----------|
| P0 | 用户无法使用 | 立即处理 |
| P1 | 功能有缺陷 | 30分钟内 |
| P2 | 新功能开发 | 正常队列 |
| P3 | 优化、文档 | 空闲时 |

### 4.3 任务完成

```javascript
TaskUpdate({ taskId: "1", status: "completed" })

SendMessage({
  type: "message",
  recipient: "product-owner",
  content: `任务完成: <任务名>

完成了什么（用户视角）:
- 用户现在可以...

技术说明（如需要）:
- ...`,
  summary: "任务完成"
})
```

---

## 5. 用户验收规则 ⭐ 新增

### 5.1 验收时机

必须在以下节点进行用户验收：
- 完整功能开发完成后
- 问题修复完成后
- 关键里程碑完成后

### 5.2 验收清单

```yaml
用户指标（必须通过，带量化标准）:
  - 功能覆盖: 100% 覆盖用户描述的使用场景
  - 易用性: ≤ 5 分钟掌握基本操作
  - 说明完整性: 3 步以内完成主要功能说明
  - product-owner 确认: 明确书面确认
  - qa-verifier 通过: 无高/中严重度问题

技术指标（内部保障）:
  - 代码审查通过
  - 测试覆盖率 90%+
  - 无已知安全漏洞
```

### 5.3 验收报告模板

```markdown
# 验收报告

## 任务信息
- 任务: <任务名>
- 用户原始需求: <原文>
- 完成时间: <时间>

## 验收结论
[通过 / 不通过 / 有条件通过]

## 符合预期的部分
1. ...
2. ...

## 用户视角的问题
| 问题 | 严重度 | 建议 |
|------|--------|------|
| ... | 高/中/低 | ... |

## 向用户展示的说明
这个功能可以帮您...
使用方法是...
```

### 5.4 "有条件通过"处理流程 ⭐ 新增

当 qa-verifier 给出"有条件通过"结论时：

```javascript
// Step 1: 记录条件并确认
SendMessage({
  recipient: "product-owner",
  content: `[有条件通过]

需要满足的条件:
- <条件1>（严重度：中，预计修复时间：<时间>）
- <条件2>（严重度：低，可后续处理）

建议处理方案:
1. 立即修复高/中严重度问题
2. 低严重度问题记录为后续优化项

请确认是否接受此方案？`,
  summary: "有条件通过处理"
})

// Step 2: 根据用户决定执行
// - 用户接受 → 修复条件 → 直接进入交付
// - 用户不接受 → 返回 Phase 4 全面修改
```

**处理原则**：
- 高严重度问题：必须立即修复
- 中严重度问题：建议立即修复，可协商
- 低严重度问题：可记录为后续优化项

### 5.5 用户不满意处理

```javascript
// 用户验收不通过时
// 1. 收集具体问题
SendMessage({
  recipient: "product-owner",
  content: `[验收不通过]

用户反馈:
- <具体问题1>
- <具体问题2>

建议处理:
1. <调整方案>
2. <预计时间>

请确认优先级和调整方向。`,
  summary: "验收不通过"
})

// 2. 调整方案
// 3. 重新实现
// 4. 再次验收
```

---

## 6. 上下文管理

### 6.1 共享上下文结构

```
.claude/teams/{team-name}/
├── context.md      # 共享上下文
├── decisions.md    # 决策记录
├── user-needs.md   # 用户需求（用户友好版）⭐
└── progress.md     # 进度摘要
```

### 6.2 user-needs.md 模板

```markdown
# 用户需求

## 用户原始描述
<原文>

## 核心问题
<用户真正想解决的问题>

## 验收标准（用户视角）
- [ ] ...
- [ ] ...

## 已确认的需求变更
| 时间 | 变更 | 原因 |
|------|------|------|
| ... | ... | ... |

## 向用户确认过的决策
- 决策1: <内容> - 用户确认时间
- 决策2: <内容> - 用户确认时间
```

---

## 7. 失败恢复

### 7.1 成员生成失败

```javascript
// 重试策略
const fallbackTypes = ['general-purpose', 'Plan', 'Explore', 'Bash'];
// 最多3次，然后创建简化版
```

### 7.2 需求偏离

```javascript
SendMessage({
  type: "message",
  recipient: "product-owner",
  content: `[需求偏离警告]

当前实现可能与用户预期不符。

原因: <具体原因>
影响: <对用户的影响>
建议: <调整方案>

请确认是否需要调整或向用户确认。`,
  summary: "需求偏离警告"
})
```

### 7.3 错误升级路径

```
成员遇到问题
    ↓
自行解决（5分钟）
    ↓
请求团队协助
    ↓
请求 tech-lead 介入（10分钟无响应）
    ↓
请求 product-owner 决策（影响用户需求时）
    ↓
暂停任务，向用户说明
```

---

## 8. 质量保证

### 8.1 质量门禁

```
用户指标（必须通过）:
- [ ] 功能是否符合用户描述的场景？
- [ ] 用户能否理解如何使用？
- [ ] 是否有用户友好的使用说明？

技术指标（内部保障）:
- [ ] 代码审查通过
- [ ] 测试覆盖率 90%+
- [ ] 无已知安全漏洞
- [ ] 无 console.log
- [ ] 无 hardcoded secrets
```

### 8.2 分层审查

```
L1: 自审查（执行者）
L2: 交叉审查（同事）
L3: 用户验收（qa-verifier）
L4: 产品确认（product-owner）
```

---

## 9. 快速参考

### 用户沟通原则

```
✅ 使用简单语言
✅ 讲用户关心的（影响）
✅ 定期汇报进度
✅ 需要确认时主动询问
✅ 完成后展示成果

❌ 使用技术术语
❌ 只说做了什么，不说对用户有什么用
❌ 不汇报进度
❌ 自行假设用户需求
```

### 禁止事项

```
❌ 不声明就编辑共享文件
❌ Hardcode 密钥
❌ 跳过用户验收
❌ 未验证就标记完成
❌ 长时间无响应（>30分钟）
❌ 使用用户听不懂的语言
❌ 不向用户确认就做关键决策
```

### 必须事项

```
✅ 编辑前声明所有权
✅ 完成后通知依赖方
✅ 发现阻塞立即报告
✅ 用简单语言向用户沟通
✅ 关键决策向用户确认
✅ 完成后进行用户验收
✅ 提供用户友好的使用说明
```
